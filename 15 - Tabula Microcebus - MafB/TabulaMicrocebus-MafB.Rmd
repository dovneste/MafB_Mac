---
title: "Tabula Microcebus - MafB"
author: "Domien"
date: "`r format (Sys.time(), format='%Y-%m-%d %H:%M:%S %z')`"
output:
  pdf_document:
    toc: yes
    toc_depth: 2
  header-includes: "-| ```{=latex} \\usepackage{fvextra} \\DefineVerbatimEnvironment{Highlighting}{Verbatim}{
    breaksymbolleft={}, showspaces = false, showtabs = false, breaklines, commandchars=\\\\\\{\\}
    } ```"
  html_document:
    toc: yes
    toc_depth: '2'
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 60), tidy = TRUE)
```

\newpage

# Introduction

To investigate the conservedness of MafB to imprint Mac identity across species we quantified the correlation between Mafb expression and the expression of macrophage sigature genes and MafB target genes in single cell atlases of mouse (Tabula Muris Senis), human (Tabula Sapiens), lemur (Tabula Microcebus), pig (Pig Cell Atlas), African clawed frog (Xenopus Cell Landscape) and zebrafish (Zebrafish Cell Landscape, ZCL).

# Load packages

```{r}
suppressMessages({
library(SeuratObject)
library(Seurat)
library(reticulate)
library(sceasy)
library(ggplot2)
library(ggrastr)
library(readxl)
})
```

# Download Tabula Microcebus scanpy object from Figshare server
```{bash, eval = FALSE}
https://figshare.com/articles/dataset/Tabula_Microcebus_v1_0/14468196?file=31777475
```

# Convert Scanpy object to Seurat object
```{r, eval = FALSE}
sceasy::convertFormat("LCA_complete_wRaw_toPublish.h5ad", from="anndata", to="seurat",
                       outFile='TBM.rds')
```

# Load Tabula Microcebus Seurat object

```{r}
TBM <- readRDS("/media/uliege/T7/SingleCellAtlas/TBM.rds")
```

# Visualize clusters

```{r fig.height=4, fig.width=4}
p1 <- DimPlot(TBM, group.by = "free_annotation_v1", raster = F)+
  theme(legend.position='none')+ggtitle("Tabula Microcebus")

rasterize(p1, layers='Point', dpi=1200)
```

# Calculate correlation between MAFB expression and Mac signature score

```{r fig.height=4, fig.width=4.5}
FeaturePlot(TBM, features = "MAFB", raster = T)
```

```{r}
Mac_sign <- read_excel("Mac_sign_lemur.xlsx")

Mac_sign <- Mac_sign$ortholog_name

Mac_sign <- intersect(Mac_sign, rownames(TBM))

TBM <- AddModuleScore(TBM, features = list(c(Mac_sign)), name = "Mac_sign")
```

```{r fig.height=4, fig.width=4}
FeatureScatter(TBM, feature1 = "MAFB", feature2 = "Mac_sign1", raster = T)+
  geom_smooth(method='lm', colour = "black")+
  theme(legend.position='none')
```

```{r}
corr <- FetchData(TBM, vars = "MAFB") 
corr <- cbind(corr, FetchData(TBM, vars = "Mac_sign1"))

cor.test(corr$MAFB, corr$Mac_sign1, method = "pearson")
```

```{r fig.height=4, fig.width=4}
p2 <- ggplot(corr, aes(x = MAFB, y = Mac_sign1))+
  geom_point(size = 0.1, colour="grey")+
  geom_smooth(method='lm', colour = "black")+
  xlab("MAFB Expression")+
  ylab("Macrophage signature score")+
  theme_classic()

rasterize(p2, layers='Point', dpi=600)
```

# Calculate correlation between MAFB expression and MafB target gene signature score

```{r}
Conserved_MafB_target_genes <- read.csv("Conserved_MafB_target_genes_microcebus.csv")

Conserved_MafB_target_genes <- Conserved_MafB_target_genes$ortholog_name

Conserved_MafB_target_genes <- intersect(Conserved_MafB_target_genes, rownames(TBM))

TBM <- AddModuleScore(TBM, features = list(c(Conserved_MafB_target_genes)), name = "MafB_target_sign")
```

```{r fig.height=4, fig.width=4}
FeatureScatter(TBM, feature1 = "MAFB", feature2 = "MafB_target_sign1", raster = T)+
  geom_smooth(method='lm', colour = "black")+
  theme(legend.position='none')
```

```{r}
corr <- cbind(corr, FetchData(TBM, vars = "MafB_target_sign1"))

cor.test(corr$MAFB, corr$MafB_target_sign1, method = "pearson")
```

```{r fig.height=4, fig.width=4}
p3 <- ggplot(corr, aes(x = MAFB, y = MafB_target_sign1))+
  geom_point(size = 0.1, colour="grey")+
  geom_smooth(method='lm', colour = "black")+
  xlab("MAFB Expression")+
  ylab("MafB target gene signature score")+
  theme_classic()
rasterize(p3, layers='Point', dpi=600)
```

```{r}
sessionInfo()
```

